---
import KeyboardShortcuts from "./KeyboardShortcuts.astro";
import Icon from "../ui/Icon.astro";

const { toc } = Astro.locals.starlightRoute;
const { modes } = Astro.locals.starlightViewModes;

interface Props {
  type: "social-links" | "table-of-contents";
}

const { type } = Astro.props;
const defaultMode = modes.find((mode) => mode.name === "default");
const nonDefaultModes = modes.filter((mode) => mode.name !== "default");

const switchHref = (mode: (typeof modes)[number]) =>
  mode.isCurrent ? defaultMode?.href ?? mode.href : mode.href;

const switchText = (mode: (typeof modes)[number]) =>
  Astro.locals.t(
    mode.isCurrent
      ? defaultMode?.switchToText ?? mode.switchToText
      : mode.switchToText
  );
---

{
  type === "social-links" && (
    <>
      {nonDefaultModes.map((mode) => (
        <a
          href={switchHref(mode)}
          class="sl-flex starlight-view-modes-social-link-a starlight-view-modes-switcher-a"
        >
          <span class="sr-only">{switchText(mode)}</span>
          <Icon set:html={mode.icon} />
        </a>
      ))}
    </>
  )
}

{
  toc && type === "table-of-contents" && (
    <div class="starlight-view-modes-table-of-contents-container">
      {nonDefaultModes.length > 0 && (
        <>
          <h2>{Astro.locals.t("starlightViewModes.switchesHeading")}</h2>
          <ul>
            {nonDefaultModes.map((mode) => (
              <li class="starlight-view-modes-table-of-contents-item">
                <a
                  href={switchHref(mode)}
                  class="starlight-view-modes-switcher-a"
                >
                  {switchText(mode)}
                </a>
                {mode.keyboardShortcuts && (
                  <KeyboardShortcuts shortcuts={mode.keyboardShortcuts} />
                )}
              </li>
            ))}
          </ul>
        </>
      )}
    </div>
  )
}

<script>
  function updateModeLinksWithHash() {
    const hash = window.location.hash;
    document
      .querySelectorAll(".starlight-view-modes-switcher-a")
      .forEach((link) => {
        // @ts-ignore
        if (link.href) {
          // @ts-ignore
          link.href = link.href.split("#")[0] + hash;
        }
      });
  }

  updateModeLinksWithHash();
  window.addEventListener("hashchange", updateModeLinksWithHash);
</script>

<style>
  .starlight-view-modes-social-link-a {
    color: var(--sl-color-text-accent);
  }
  .starlight-view-modes-social-link-a:hover {
    opacity: 0.66;
  }

  .starlight-view-modes-table-of-contents-container {
    margin-top: 1rem;
  }
  .starlight-view-modes-table-of-contents-container ul {
    padding: 0;
    list-style: none;
  }
  .starlight-view-modes-table-of-contents-container a {
    --pad-inline: 0.5rem;
    display: block;
    border-radius: 0.25rem;
    padding-block: 0.25rem;
    padding-inline: var(--pad-inline);
    line-height: 1.25;
  }
  .starlight-view-modes-table-of-contents-item {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
</style>

<style is:global>
  .sl-container {
    display: block;
  }
</style>

